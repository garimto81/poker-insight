
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GG POKER ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Chart.jsëŠ” ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
    <script src="./supabase-integration.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; margin: 0 auto; 
            background: rgba(255,255,255,0.95); 
            border-radius: 15px; padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; margin: 0; }
        .header p { color: #7f8c8d; margin: 5px 0; }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        .stat-card { 
            background: white; padding: 20px; border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #3498db; }
        .stat-label { color: #7f8c8d; margin-top: 5px; }
        .chart-container { 
            background: white; padding: 20px; border-radius: 10px; 
            margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chart-header h3 {
            margin: 0;
        }
        .period-selector {
            display: flex;
            gap: 5px;
        }
        .period-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .period-btn:hover {
            background: #f0f0f0;
        }
        .period-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        .chart-wrapper { position: relative; height: 400px; }
        .gg-highlight { 
            border-left: 4px solid #e74c3c; 
            position: relative;
        }
        .gg-highlight::before {
            content: "GG";
            position: absolute;
            top: 5px;
            right: 10px;
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
        }
        .last-updated { 
            text-align: center; color: #7f8c8d; 
            font-size: 0.9em; margin-top: 20px; 
        }
        
        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        .loading-indicator {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #7f8c8d;
        }
        
        .loading-spinner {
            display: inline-block;
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì˜¨ë¼ì¸ í¬ì»¤ ì‚¬ì´íŠ¸ ë¶„ì„ v1.3.2</h1>
            <p>ì‹¤ì‹œê°„ í¬ì»¤ ì‚¬ì´íŠ¸ íŠ¸ë˜í”½ ë¶„ì„ â€¢ ìë™ ì—…ë°ì´íŠ¸ â€¢ ê¸€ë¡œë²Œ í¬ì»¤ ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§</p>
        </div>
        
        <div id="loading-indicator" class="loading-indicator">
            <div class="loading-spinner">âŸ³</div>
            ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë”© ì¤‘...
        </div>
        
        <div id="error-container"></div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-sites">ë¡œë”© ì¤‘...</div>
                <div class="stat-label">ë¶„ì„ ëŒ€ìƒ ì‚¬ì´íŠ¸</div>
            </div>
            <div class="stat-card gg-highlight">
                <div class="stat-number" id="total-players">ë¡œë”© ì¤‘...</div>
                <div class="stat-label">ì „ì²´ ì ‘ì†ì ìˆ˜</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3>Players Online</h3>
                <div class="period-selector">
                    <button class="period-btn active" data-period="7d" data-chart="onlinePlayersChart">7ì¼</button>
                    <button class="period-btn" data-period="1m" data-chart="onlinePlayersChart">1ê°œì›”</button>
                    <button class="period-btn" data-period="3m" data-chart="onlinePlayersChart">3ê°œì›”</button>
                    <button class="period-btn" data-period="6m" data-chart="onlinePlayersChart">6ê°œì›”</button>
                    <button class="period-btn" data-period="1y" data-chart="onlinePlayersChart">1ë…„</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="onlinePlayersChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3>Cash Players</h3>
                <div class="period-selector">
                    <button class="period-btn active" data-period="7d" data-chart="cashPlayersChart">7ì¼</button>
                    <button class="period-btn" data-period="1m" data-chart="cashPlayersChart">1ê°œì›”</button>
                    <button class="period-btn" data-period="3m" data-chart="cashPlayersChart">3ê°œì›”</button>
                    <button class="period-btn" data-period="6m" data-chart="cashPlayersChart">6ê°œì›”</button>
                    <button class="period-btn" data-period="1y" data-chart="cashPlayersChart">1ë…„</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="cashPlayersChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3>24 H Peak</h3>
                <div class="period-selector">
                    <button class="period-btn active" data-period="7d" data-chart="peak24hChart">7ì¼</button>
                    <button class="period-btn" data-period="1m" data-chart="peak24hChart">1ê°œì›”</button>
                    <button class="period-btn" data-period="3m" data-chart="peak24hChart">3ê°œì›”</button>
                    <button class="period-btn" data-period="6m" data-chart="peak24hChart">6ê°œì›”</button>
                    <button class="period-btn" data-period="1y" data-chart="peak24hChart">1ë…„</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="peak24hChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3>7 Day Avg</h3>
                <div class="period-selector">
                    <button class="period-btn active" data-period="7d" data-chart="sevenDayAvgChart">7ì¼</button>
                    <button class="period-btn" data-period="1m" data-chart="sevenDayAvgChart">1ê°œì›”</button>
                    <button class="period-btn" data-period="3m" data-chart="sevenDayAvgChart">3ê°œì›”</button>
                    <button class="period-btn" data-period="6m" data-chart="sevenDayAvgChart">6ê°œì›”</button>
                    <button class="period-btn" data-period="1y" data-chart="sevenDayAvgChart">1ë…„</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="sevenDayAvgChart"></canvas>
            </div>
        </div>
        
        <div class="last-updated" id="last-updated">
            ë°ì´í„° ë¡œë”© ì¤‘...
        </div>
    </div>

    <script>
        // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
        window.addEventListener('error', function(e) {
            console.error('ğŸš¨ ì „ì—­ JavaScript ì˜¤ë¥˜:', e.error);
            console.error('íŒŒì¼:', e.filename, 'ë¼ì¸:', e.lineno, 'ì»¬ëŸ¼:', e.colno);
            
            const loadingEl = document.getElementById('loading-indicator');
            const errorContainer = document.getElementById('error-container');
            
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>âŒ JavaScript ì˜¤ë¥˜ ë°œìƒ:</strong> ${e.error.message}<br>
                        <small>íŒŒì¼: ${e.filename} (ë¼ì¸: ${e.lineno})</small><br>
                        <small>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</small>
                    </div>
                `;
            }
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('ğŸš¨ ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', e.reason);
            
            const loadingEl = document.getElementById('loading-indicator');
            const errorContainer = document.getElementById('error-container');
            
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="error-message">
                        <strong>âŒ ë¹„ë™ê¸° ì‘ì—… ì‹¤íŒ¨:</strong> ${e.reason}<br>
                        <small>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</small>
                    </div>
                `;
            }
        });
        
        // Supabase ì„¤ì • (í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” ì„¤ì •)
        // ì‹¤ì œ ì‚¬ìš© ì‹œ ì´ ê°’ë“¤ì„ ì‹¤ì œ Supabase í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´í•˜ì„¸ìš”
        window.SUPABASE_URL = ''; // 'https://your-project.supabase.co'
        window.SUPABASE_ANON_KEY = ''; // 'your-anon-key'
        
        // ì „ì—­ ë³€ìˆ˜
        let dashboardData;
        let chartInstances = {};
        
        console.log('ğŸš€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹œì‘ - v1.3.2');
        
        // Chart.js ë™ì  ë¡œë”© í•¨ìˆ˜
        async function ensureChartJSLoaded() {
            return new Promise((resolve, reject) => {
                // ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ë°˜í™˜
                if (typeof Chart !== 'undefined') {
                    console.log('âœ… Chart.js ì´ë¯¸ ë¡œë“œë¨:', Chart.version);
                    resolve(true);
                    return;
                }
                
                console.log('ğŸ“¦ Chart.js ë™ì  ë¡œë”© ì‹œì‘...');
                
                // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                const existingScript = document.querySelector('script[src*="chart.js"]');
                if (existingScript) {
                    console.log('ğŸ”„ ê¸°ì¡´ Chart.js ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ë°œê²¬, ì¬ì‹œë„...');
                    existingScript.remove();
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
                script.async = true;
                
                script.onload = () => {
                    if (typeof Chart !== 'undefined') {
                        console.log('âœ… Chart.js ë™ì  ë¡œë”© ì„±ê³µ:', Chart.version);
                        resolve(true);
                    } else {
                        console.error('âŒ Chart.js ë¡œë“œë˜ì—ˆì§€ë§Œ Chart ê°ì²´ ì—†ìŒ');
                        reject(new Error('Chart.js ë¡œë“œë˜ì—ˆì§€ë§Œ Chart ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
                    }
                };
                
                script.onerror = (error) => {
                    console.error('âŒ Chart.js ë™ì  ë¡œë”© ì‹¤íŒ¨:', error);
                    reject(new Error('Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'));
                };
                
                document.head.appendChild(script);
                
                // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
                setTimeout(() => {
                    if (typeof Chart === 'undefined') {
                        console.error('âŒ Chart.js ë¡œë”© íƒ€ì„ì•„ì›ƒ');
                        reject(new Error('Chart.js ë¡œë”© íƒ€ì„ì•„ì›ƒ (10ì´ˆ)'));
                    }
                }, 10000);
            });
        }
        
        // ê°œì„ ëœ ë°ì´í„° ë¡œë”© í•¨ìˆ˜ (Supabase + CORS ì´ìŠˆ í•´ê²°)
        async function loadDashboardData() {
            console.log('ğŸ”„ ë°ì´í„° ë¡œë”© ì‹œì‘...');
            
            // Supabase ì—°ë™ í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹
            if (typeof loadDashboardDataEnhanced !== 'undefined') {
                console.log('ğŸ”— Supabase ëª¨ë“œë¡œ ë°ì´í„° ë¡œë”© ì‹œë„...');
                return await loadDashboardDataEnhanced();
            }
            
            // ê¸°ì¡´ JSON íŒŒì¼ ë°©ì‹ (fallback)
            console.log('ğŸ“„ JSON íŒŒì¼ ëª¨ë“œë¡œ ë°ì´í„° ë¡œë”©...');
            const errorContainer = document.getElementById('error-container');
            
            try {
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
                
                // CORS ì´ìŠˆ ê°ì§€ë¥¼ ìœ„í•œ timeout ì„¤ì •
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ì´ˆ timeout
                
                const response = await fetch('./api_data.json', {
                    signal: controller.signal,
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('âœ… JSON íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ');
                return data;
                
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                
                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                if (errorContainer) {
                    let errorMessage = '';
                    if (error.name === 'TypeError' || error.message.includes('fetch')) {
                        errorMessage = `
                            <div class="error-message">
                                <strong>ğŸš« CORS ì ‘ê·¼ ì œí•œ:</strong> ë¸Œë¼ìš°ì € ë³´ì•ˆì •ì±…ìœ¼ë¡œ ì¸í•´ ë¡œì»¬ íŒŒì¼ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                                <small><strong>í•´ê²°ë°©ë²•:</strong> HTTP ì„œë²„ë¡œ ì‹¤í–‰í•˜ê±°ë‚˜ Supabase ì—°ë™ì„ ì‚¬ìš©í•˜ì„¸ìš”</small><br>
                                <code>python -m http.server 8000</code> ì‹¤í–‰ í›„ <code>http://localhost:8000</code> ì ‘ì†
                            </div>
                        `;
                    } else {
                        errorMessage = `
                            <div class="error-message">
                                <strong>âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:</strong> ${error.message}<br>
                                <small>Supabase ì„¤ì •ì„ í™•ì¸í•˜ê±°ë‚˜ HTTP ì„œë²„ì—ì„œ ì‹¤í–‰í•´ë³´ì„¸ìš”</small>
                            </div>
                        `;
                    }
                    errorContainer.innerHTML = errorMessage;
                }
                
                // ë” ìì„¸í•œ fallback ë°ì´í„° (ë°ëª¨ìš©)
                console.log('ğŸ”„ fallback ë°ì´í„° ì‚¬ìš©');
                return {
                    "last_updated": new Date().toISOString(),
                    "data_period_days": 30,
                    "sites": {
                        "Demo Mode": {
                            "name": "Demo Mode",
                            "category": "DEMO",
                            "data": {
                                "dates": [new Date().toISOString().split('T')[0]],
                                "players_online": [0],
                                "cash_players": [0],
                                "peak_24h": [0],
                                "seven_day_avg": [0]
                            }
                        }
                    },
                    "dates": [new Date().toISOString().split('T')[0]],
                    "summary": {
                        "total_sites": 1,
                        "gg_poker_sites": 0,
                        "latest_total_players": 0,
                        "data_points": 1
                    }
                };
            }
        }
        
        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatistics(data) {
            try {
                const totalSitesEl = document.getElementById('total-sites');
                const totalPlayersEl = document.getElementById('total-players');
                
                if (totalSitesEl) {
                    totalSitesEl.textContent = data.summary.total_sites || 0;
                }
                
                if (totalPlayersEl) {
                    const players = data.summary.latest_total_players || 0;
                    totalPlayersEl.textContent = players.toLocaleString('ko-KR');
                }
            } catch (error) {
                console.error('Error updating statistics:', error);
            }
        }
        
        // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTimestamp(data) {
            try {
                const lastUpdatedEl = document.getElementById('last-updated');
                if (lastUpdatedEl && data.last_updated) {
                    const lastUpdated = new Date(data.last_updated);
                    lastUpdatedEl.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${lastUpdated.toLocaleString('ko-KR')}`;
                }
            } catch (error) {
                console.error('Error updating timestamp:', error);
                const lastUpdatedEl = document.getElementById('last-updated');
                if (lastUpdatedEl) {
                    lastUpdatedEl.textContent = 'ì—…ë°ì´íŠ¸ ì‹œê°„ í™•ì¸ ë¶ˆê°€';
                }
            }
        }
        
        // ë©”ì¸ ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializeDashboard() {
            const loadingEl = document.getElementById('loading-indicator');
            const errorContainer = document.getElementById('error-container');
            
            console.log('ğŸš€ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹œì‘...');
            
            // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
            if (loadingEl) {
                loadingEl.style.display = 'block';
            }
            
            try {
                // 1. ë°ì´í„° ë¡œë“œ
                console.log('ğŸ“Š 1ë‹¨ê³„: ë°ì´í„° ë¡œë“œ');
                dashboardData = await loadDashboardData();
                
                // 2. í†µê³„ ì—…ë°ì´íŠ¸
                console.log('ğŸ“ˆ 2ë‹¨ê³„: í†µê³„ ì—…ë°ì´íŠ¸');
                updateStatistics(dashboardData);
                
                // 3. íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
                console.log('â° 3ë‹¨ê³„: íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸');
                updateTimestamp(dashboardData);
                
                // 4. Chart.js ë¡œë”© í™•ì¸ ë° ì°¨íŠ¸ ìƒì„±
                console.log('ğŸ“Š 4ë‹¨ê³„: Chart.js ë¡œë”© ë° ì°¨íŠ¸ ìƒì„±');
                if (dashboardData.sites && Object.keys(dashboardData.sites).length > 0) {
                    try {
                        await ensureChartJSLoaded();
                        createAllCharts();
                        console.log('âœ… ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
                    } catch (chartError) {
                        console.error('âŒ Chart.js ë¡œë”© ì‹¤íŒ¨:', chartError);
                        
                        // Chart.js ë¡œë”© ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                        if (errorContainer) {
                            errorContainer.innerHTML = `
                                <div class="error-message">
                                    <strong>âš ï¸ ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨:</strong> ${chartError.message}<br>
                                    <small>ì°¨íŠ¸ëŠ” í‘œì‹œë˜ì§€ ì•Šì§€ë§Œ ë°ì´í„°ëŠ” ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤</small>
                                </div>
                            `;
                        }
                    }
                } else {
                    console.warn('âš ï¸ ì°¨íŠ¸ìš© ì‚¬ì´íŠ¸ ë°ì´í„° ì—†ìŒ');
                }
                
                console.log('ğŸ‰ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ!');
                
            } catch (error) {
                console.error('âŒ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                
                if (errorContainer) {
                    errorContainer.innerHTML = `
                        <div class="error-message">
                            <strong>âŒ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:</strong> ${error.message}<br>
                            <small>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”</small>
                        </div>
                    `;
                }
            } finally {
                // í•­ìƒ ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
                console.log('ğŸ”„ ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }
        }
        
        // ê¸€ë¡œë²Œ ë³€ìˆ˜
        let chartInstances = {};
        
        // ê¸°ê°„ë³„ ë°ì´í„° í•„í„°ë§ í•¨ìˆ˜
        function filterDataByPeriod(siteData, period) {
            const dates = siteData.dates;
            const dataLength = dates.length;
            
            let startIndex = 0;
            const now = new Date();
            
            switch(period) {
                case '7d':
                    startIndex = Math.max(0, dataLength - 7);
                    break;
                case '1m':
                    startIndex = Math.max(0, dataLength - 30);
                    break;
                case '3m':
                    startIndex = Math.max(0, dataLength - 90);
                    break;
                case '6m':
                    startIndex = Math.max(0, dataLength - 180);
                    break;
                case '1y':
                    startIndex = Math.max(0, dataLength - 365);
                    break;
                default:
                    startIndex = Math.max(0, dataLength - 7);
            }
            
            return {
                dates: dates.slice(startIndex),
                players_online: siteData.players_online.slice(startIndex),
                cash_players: siteData.cash_players.slice(startIndex),
                peak_24h: siteData.peak_24h.slice(startIndex),
                seven_day_avg: siteData.seven_day_avg.slice(startIndex)
            };
        }
        
        // ê³µí†µ í•¨ìˆ˜: ë°ì´í„°ë³„ ìƒìœ„ 5ê°œ ì‚¬ì´íŠ¸ ì¶”ì¶œ (ê¸°ê°„ í•„í„°ë§ í¬í•¨)
        function getTop5Sites(dataType, period = '7d') {
            const sites = Object.keys(dashboardData.sites).map(siteName => {
                const siteData = dashboardData.sites[siteName];
                const filteredData = filterDataByPeriod(siteData.data, period);
                let value = 0;
                
                switch(dataType) {
                    case 'players_online':
                        // ê¸°ê°„ ë‚´ í‰ê· ê°’ ê³„ì‚°
                        value = filteredData.players_online.reduce((sum, val) => sum + (val || 0), 0) / filteredData.players_online.length || 0;
                        break;
                    case 'cash_players':
                        value = filteredData.cash_players.reduce((sum, val) => sum + (val || 0), 0) / filteredData.cash_players.length || 0;
                        break;
                    case 'peak_24h':
                        // ê¸°ê°„ ë‚´ ìµœëŒ€ê°’
                        value = Math.max(...filteredData.peak_24h.filter(val => val !== undefined && val !== null)) || 0;
                        break;
                    case 'seven_day_avg':
                        value = filteredData.seven_day_avg.reduce((sum, val) => sum + (val || 0), 0) / filteredData.seven_day_avg.length || 0;
                        break;
                }
                
                return {
                    name: siteName,
                    value: Math.round(value),
                    isGG: siteData.category === 'GG_POKER'
                };
            });
            
            return sites
                .filter(site => site.value > 0)
                .sort((a, b) => b.value - a.value)
                .slice(0, 5);
        }
        
        // ê³µí†µ í•¨ìˆ˜: ì°¨íŠ¸ ìƒì„±
        function createBarChart(canvasId, title, dataType, period = '7d') {
            try {
                console.log(`ğŸ“Š ì°¨íŠ¸ ìƒì„± ì‹œì‘: ${canvasId} (${title})`);
                
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    throw new Error(`Canvas ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${canvasId}`);
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    throw new Error(`Canvas context ìƒì„± ì‹¤íŒ¨: ${canvasId}`);
                }
                
                // Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                }
                
                // ê¸°ì¡´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì œê±°
                if (chartInstances[canvasId]) {
                    console.log(`ğŸ”„ ê¸°ì¡´ ì°¨íŠ¸ ì œê±°: ${canvasId}`);
                    chartInstances[canvasId].destroy();
                }
                
                const top5 = getTop5Sites(dataType, period);
                
                if (!top5 || top5.length === 0) {
                    console.warn(`âš ï¸ ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ: ${canvasId}`);
                    return;
                }
                
                const labels = top5.map(site => site.isGG ? `${site.name} [GG]` : site.name);
                const data = top5.map(site => site.value);
                const colors = top5.map(site => site.isGG ? '#e74c3c' : '#3498db');
                
                console.log(`ğŸ“ˆ ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ: ${labels.length}ê°œ í•­ëª©`);
                
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: title,
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 2,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
                
                console.log(`âœ… ì°¨íŠ¸ ìƒì„± ì™„ë£Œ: ${canvasId}`);
                
            } catch (error) {
                console.error(`âŒ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨ (${canvasId}):`, error);
                
                // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆì— ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                const canvas = document.getElementById(canvasId);
                if (canvas && canvas.parentElement) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'text-align: center; padding: 20px; color: #666; font-size: 14px;';
                    errorDiv.innerHTML = `âŒ ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨<br><small>${error.message}</small>`;
                    canvas.parentElement.appendChild(errorDiv);
                    canvas.style.display = 'none';
                }
            }
        }
        
        // ì°¨íŠ¸ ì˜ì—­ì— ëŒ€ì²´ ë©”ì‹œì§€ í‘œì‹œ
        function showChartFallback(message = 'Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨') {
            const chartIds = ['onlinePlayersChart', 'cashPlayersChart', 'peak24hChart', 'sevenDayAvgChart'];
            
            chartIds.forEach(chartId => {
                const canvas = document.getElementById(chartId);
                if (canvas && canvas.parentElement) {
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.style.cssText = `
                        text-align: center; 
                        padding: 60px 20px; 
                        color: #666; 
                        font-size: 16px;
                        background: #f9f9f9;
                        border-radius: 10px;
                        border: 2px dashed #ddd;
                    `;
                    fallbackDiv.innerHTML = `
                        ğŸ“Š ì°¨íŠ¸ ì˜ì—­<br>
                        <small style="color: #999;">${message}</small><br>
                        <small style="color: #999;">ë°ì´í„°ëŠ” ìœ„ì˜ í†µê³„ ì¹´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”</small>
                    `;
                    
                    canvas.style.display = 'none';
                    canvas.parentElement.appendChild(fallbackDiv);
                }
            });
        }
        
        // ëª¨ë“  ì°¨íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function createAllCharts() {
            try {
                // Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© í™•ì¸
                if (typeof Chart === 'undefined') {
                    console.error('âŒ Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                    showChartFallback('Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    return;
                }
                
                console.log('ğŸ“Š ì°¨íŠ¸ ìƒì„± ì‹œì‘...');
                
                // 4ê°œ ì°¨íŠ¸ ìƒì„± (ê¸°ë³¸ 7ì¼)
                createBarChart('onlinePlayersChart', 'Online Players', 'players_online', '7d');
                createBarChart('cashPlayersChart', 'Cash Players', 'cash_players', '7d');
                createBarChart('peak24hChart', '24H Peak', 'peak_24h', '7d');
                createBarChart('sevenDayAvgChart', '7-Day Average', 'seven_day_avg', '7d');
                
                // ê¸°ê°„ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                setupPeriodButtons();
                
                console.log('âœ… ëª¨ë“  ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                showChartFallback(`ì°¨íŠ¸ ìƒì„± ì˜¤ë¥˜: ${error.message}`);
                
                // ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                const errorContainer = document.getElementById('error-container');
                if (errorContainer) {
                    errorContainer.innerHTML += `
                        <div class="error-message">
                            <strong>âš ï¸ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨:</strong> ${error.message}<br>
                            <small>í†µê³„ ë°ì´í„°ëŠ” ìœ„ì˜ ì¹´ë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
                        </div>
                    `;
                }
            }
        }
        
        // ê¸°ê°„ ì„ íƒ ë²„íŠ¼ ì„¤ì • í•¨ìˆ˜
        function setupPeriodButtons() {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.dataset.period;
                    const chartId = this.dataset.chart;
                    
                    // ê°™ì€ ì°¨íŠ¸ì˜ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                    this.parentElement.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    // í˜„ì¬ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€  
                    this.classList.add('active');
                    
                    // í•´ë‹¹ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                    const dataTypeMap = {
                        'onlinePlayersChart': 'players_online',
                        'cashPlayersChart': 'cash_players', 
                        'peak24hChart': 'peak_24h',
                        'sevenDayAvgChart': 'seven_day_avg'
                    };
                    
                    const titleMap = {
                        'onlinePlayersChart': 'Online Players',
                        'cashPlayersChart': 'Cash Players',
                        'peak24hChart': '24H Peak', 
                        'sevenDayAvgChart': '7-Day Average'
                    };
                    
                    createBarChart(chartId, titleMap[chartId], dataTypeMap[chartId], period);
                });
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
        